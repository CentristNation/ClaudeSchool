<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Education ZIP Dashboard â€” Advanced Analytics</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
  * {
    box-sizing: border-box;
  }
  
  html, body {
    height: 100%;
    margin: 0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  
  #app {
    display: flex;
    height: 100vh;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    margin: 10px;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
  }
  
  #map {
    flex: 1;
    border-radius: 15px 0 0 15px;
    position: relative;
    overflow: hidden;
  }
  
  #sidebar {
    width: 420px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-left: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    flex-direction: column;
    padding: 24px;
    overflow-y: auto;
    border-radius: 0 15px 15px 0;
  }
  
  h1 {
    font-size: 24px;
    font-weight: 700;
    margin: 0 0 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .section {
    margin-bottom: 24px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .section-title {
    font-size: 16px;
    font-weight: 600;
    color: #334155;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .button-group {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  }
  
  button:active {
    transform: translateY(0);
  }
  
  #clearSel {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
  }
  
  #clearSel:hover {
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
  }
  
  .filter-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  label {
    font-size: 14px;
    font-weight: 500;
    min-width: 120px;
    color: #475569;
  }
  
  input[type=number] {
    width: 100px;
    padding: 10px 14px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.8);
    transition: all 0.3s ease;
  }
  
  input[type=number]:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .basemap-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    gap: 8px;
  }
  
  .basemap-btn {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }
  
  .basemap-btn.streets {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
  }
  
  .basemap-btn.satellite {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
  }
  
  .basemap-btn.dark {
    background: linear-gradient(135deg, #374151 0%, #111827 100%);
    color: white;
  }
  
  .basemap-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  }
  
  table.dataTable {
    font-size: 13px;
    border-radius: 12px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.9);
  }
  
  table.dataTable thead th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 16px 12px;
    font-weight: 600;
  }
  
  table.dataTable tbody td {
    padding: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  table.dataTable tbody tr:hover {
    background: rgba(102, 126, 234, 0.1);
  }
  
  .chart-container {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
  }
  
  .chart-title {
    font-size: 14px;
    font-weight: 600;
    color: #334155;
    margin-bottom: 12px;
    text-align: center;
  }
  
  canvas {
    max-height: 250px;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  
  .stat-card {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #667eea;
    display: block;
  }
  
  .stat-label {
    font-size: 12px;
    color: #64748b;
    margin-top: 4px;
  }
  
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100px;
    color: #667eea;
    font-size: 16px;
  }
  
  .leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  }
  
  .leaflet-popup-content table {
    margin: 0;
    font-size: 13px;
  }
  
  .leaflet-popup-content table td {
    padding: 6px 8px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .leaflet-popup-content table td:first-child {
    font-weight: 600;
    color: #667eea;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  .pulsing {
    animation: pulse 2s infinite;
  }
</style>
</head>
<body>
<div id="app">
  <div id="map">
    <div class="basemap-controls">
      <button class="basemap-btn streets" data-basemap="streets" title="Streets">
        <i class="fas fa-map"></i>
      </button>
      <button class="basemap-btn satellite" data-basemap="satellite" title="Satellite">
        <i class="fas fa-satellite"></i>
      </button>
      <button class="basemap-btn dark" data-basemap="dark" title="Dark">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </div>
  <div id="sidebar">
    <h1><i class="fas fa-graduation-cap"></i>Education Analytics</h1>
    
    <div class="section">
      <div class="section-title">
        <i class="fas fa-draw-polygon"></i>Selection Tools
      </div>
      <div class="button-group">
        <button id="drawRect"><i class="fas fa-square"></i>Rectangle</button>
        <button id="drawPoly"><i class="fas fa-draw-polygon"></i>Polygon</button>
        <button id="clearSel"><i class="fas fa-trash"></i>Clear</button>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">
        <i class="fas fa-filter"></i>Data Filters
      </div>
      <div id="filters"></div>
    </div>
    
    <div class="section">
      <div class="section-title">
        <i class="fas fa-chart-bar"></i>Quick Stats
      </div>
      <div class="stats-grid" id="quickStats"></div>
    </div>
    
    <div class="section">
      <div class="section-title">
        <i class="fas fa-table"></i>Selected Areas
      </div>
      <table id="summary" class="display" width="100%">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div class="section">
      <div class="section-title">
        <i class="fas fa-chart-line"></i>Visualizations
      </div>
      <div class="chart-container">
        <div class="chart-title">Count Totals</div>
        <canvas id="countChart"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Percentage Averages</div>
        <canvas id="pctChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/turf@6.5.0/turf.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
(async function(){
  const GEOJSON_FILE = "education-data.geojson";
  
  // Show loading state
  document.getElementById('sidebar').innerHTML = '<div class="loading pulsing"><i class="fas fa-spinner fa-spin"></i> Loading education data...</div>';
  
  try {
    const res = await fetch(GEOJSON_FILE);
    if (!res.ok) throw new Error('Failed to load data');
    const geojson = await res.json();
    const features = geojson.features;

    // Restore sidebar content
    document.getElementById('sidebar').innerHTML = `
      <h1><i class="fas fa-graduation-cap"></i>Education Analytics</h1>
      
      <div class="section">
        <div class="section-title">
          <i class="fas fa-draw-polygon"></i>Selection Tools
        </div>
        <div class="button-group">
          <button id="drawRect"><i class="fas fa-square"></i>Rectangle</button>
          <button id="drawPoly"><i class="fas fa-draw-polygon"></i>Polygon</button>
          <button id="clearSel"><i class="fas fa-trash"></i>Clear</button>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">
          <i class="fas fa-filter"></i>Data Filters
        </div>
        <div id="filters"></div>
      </div>
      
      <div class="section">
        <div class="section-title">
          <i class="fas fa-chart-bar"></i>Quick Stats
        </div>
        <div class="stats-grid" id="quickStats"></div>
      </div>
      
      <div class="section">
        <div class="section-title">
          <i class="fas fa-table"></i>Selected Areas
        </div>
        <table id="summary" class="display" width="100%">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div class="section">
        <div class="section-title">
          <i class="fas fa-chart-line"></i>Visualizations
        </div>
        <div class="chart-container">
          <div class="chart-title">Count Totals</div>
          <canvas id="countChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">Percentage Averages</div>
          <canvas id="pctChart"></canvas>
        </div>
      </div>
    `;

    // Detect ZIP + numeric fields
    const sampleProps = features[0].properties;
    const zipKey = Object.keys(sampleProps).find(k => /zip/i.test(k));
    const numericFields = Object.keys(sampleProps).filter(k => 
      typeof sampleProps[k] === 'number' && k !== zipKey
    );

    // State management
    const state = {
      filters: {},
      selectedZips: new Set()
    };

    // Initialize filters
    numericFields.forEach(f => {
      state.filters[f] = {min: null, max: null};
    });

    // Create filters UI
    const filtersDiv = document.getElementById('filters');
    numericFields.forEach(f => {
      const row = document.createElement('div');
      row.className = 'filter-row';
      
      const label = document.createElement('label');
      label.textContent = f.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      
      const minInput = document.createElement('input');
      minInput.type = 'number';
      minInput.placeholder = 'min';
      minInput.step = 'any';
      
      const maxInput = document.createElement('input');
      maxInput.type = 'number';
      maxInput.placeholder = 'max';
      maxInput.step = 'any';
      
      minInput.oninput = () => {
        state.filters[f].min = minInput.value === '' ? null : +minInput.value;
        refreshMap();
        updateQuickStats();
      };
      
      maxInput.oninput = () => {
        state.filters[f].max = maxInput.value === '' ? null : +maxInput.value;
        refreshMap();
        updateQuickStats();
      };
      
      row.appendChild(label);
      row.appendChild(minInput);
      row.appendChild(maxInput);
      filtersDiv.appendChild(row);
    });

    // Initialize map with better center calculation
    const bounds = L.geoJSON(geojson).getBounds();
    const map = L.map('map').fitBounds(bounds, {padding: [20, 20]});

    // Basemap options
    const basemaps = {
      streets: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© OpenStreetMap, Â© CartoDB'
      }),
      satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Â© Esri'
      }),
      dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© OpenStreetMap, Â© CartoDB'
      })
    };

    let currentBasemap = basemaps.streets.addTo(map);

    // Basemap controls
    document.querySelectorAll('.basemap-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const basemapType = btn.dataset.basemap;
        map.removeLayer(currentBasemap);
        currentBasemap = basemaps[basemapType].addTo(map);
        
        // Update button states
        document.querySelectorAll('.basemap-btn').forEach(b => b.style.opacity = '0.7');
        btn.style.opacity = '1';
      });
    });

    // Set initial button state
    document.querySelector('.basemap-btn.streets').style.opacity = '1';

    // Styling
    const styleDefault = {
      color: '#667eea',
      weight: 1.5,
      fillOpacity: 0.12,
      fillColor: '#667eea'
    };
    
    const styleHighlight = {
      color: '#ef4444',
      weight: 3,
      fillOpacity: 0.4,
      fillColor: '#ef4444'
    };
    
    const styleFiltered = {
      color: '#10b981',
      weight: 1.5,
      fillOpacity: 0.08,
      fillColor: '#10b981'
    };

    let geoLayer;

    function passesFilters(props) {
      return numericFields.every(f => {
        const val = props[f];
        const {min, max} = state.filters[f];
        if (min !== null && val < min) return false;
        if (max !== null && val > max) return false;
        return true;
      });
    }

    function buildPopup(props) {
      let html = '<table style="margin: 0; border-collapse: collapse;">';
      Object.entries(props).forEach(([k, v]) => {
        const displayKey = k.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        const displayValue = typeof v === 'number' ? 
          (/_pct$/i.test(k) ? v.toFixed(2) + '%' : v.toLocaleString()) : v;
        html += `<tr><td style="padding: 6px 8px; font-weight: 600; color: #667eea;">${displayKey}</td><td style="padding: 6px 8px;">${displayValue}</td></tr>`;
      });
      html += '</table>';
      return html;
    }

    function refreshMap() {
      if (geoLayer) map.removeLayer(geoLayer);
      
      const filteredFeatures = features.filter(f => passesFilters(f.properties));
      
      geoLayer = L.geoJSON(filteredFeatures, {
        style: feature => {
          const zipCode = feature.properties[zipKey];
          if (state.selectedZips.has(zipCode)) {
            return styleHighlight;
          }
          return styleDefault;
        },
        onEachFeature: (feature, layer) => {
          layer.bindPopup(buildPopup(feature.properties));
          
          // Click to select/deselect
          layer.on('click', () => {
            const zipCode = feature.properties[zipKey];
            if (state.selectedZips.has(zipCode)) {
              state.selectedZips.delete(zipCode);
            } else {
              state.selectedZips.add(zipCode);
            }
            refreshMap();
            updateSummary();
            updateQuickStats();
          });
          
          // Hover effects
          layer.on('mouseover', function() {
            if (!state.selectedZips.has(feature.properties[zipKey])) {
              this.setStyle({
                weight: 3,
                fillOpacity: 0.25
              });
            }
          });
          
          layer.on('mouseout', function() {
            if (!state.selectedZips.has(feature.properties[zipKey])) {
              this.setStyle(styleDefault);
            }
          });
        }
      }).addTo(map);
    }

    // Drawing tools
    const drawnItems = new L.FeatureGroup().addTo(map);
    const drawControl = new L.Control.Draw({
      edit: {featureGroup: drawnItems},
      draw: {
        marker: false,
        circle: false,
        polyline: false,
        circlemarker: false,
        polygon: {
          shapeOptions: {
            color: '#667eea',
            fillOpacity: 0.2
          }
        },
        rectangle: {
          shapeOptions: {
            color: '#667eea',
            fillOpacity: 0.2
          }
        }
      }
    });
    map.addControl(drawControl);

    function selectInShape(shape) {
      const filteredFeatures = features.filter(f => passesFilters(f.properties));
      filteredFeatures.forEach(feature => {
        try {
          if (turf.booleanIntersects(shape, feature)) {
            state.selectedZips.add(feature.properties[zipKey]);
          }
        } catch (e) {
          // Handle geometry errors gracefully
          console.warn('Geometry intersection error:', e);
        }
      });
    }

    map.on(L.Draw.Event.CREATED, e => {
      const shape = e.layer.toGeoJSON();
      drawnItems.addLayer(e.layer);
      selectInShape(shape);
      refreshMap();
      updateSummary();
      updateQuickStats();
    });

    // Button event listeners
    document.getElementById('clearSel').onclick = () => {
      state.selectedZips.clear();
      drawnItems.clearLayers();
      refreshMap();
      updateSummary();
      updateQuickStats();
    };

    // Quick stats function
    function updateQuickStats() {
      const filteredFeatures = features.filter(f => passesFilters(f.properties));
      const selectedFeatures = filteredFeatures.filter(f => 
        state.selectedZips.has(f.properties[zipKey])
      );
      
      const quickStatsDiv = document.getElementById('quickStats');
      quickStatsDiv.innerHTML = `
        <div class="stat-card">
          <span class="stat-value">${filteredFeatures.length}</span>
          <div class="stat-label">Total Areas</div>
        </div>
        <div class="stat-card">
          <span class="stat-value">${selectedFeatures.length}</span>
          <div class="stat-label">Selected</div>
        </div>
      `;
    }

    // Aggregation function
    function aggregate() {
      const selectedFeatures = features.filter(f => 
        state.selectedZips.has(f.properties[zipKey]) && passesFilters(f.properties)
      );
      
      const byZip = {};
      selectedFeatures.forEach(feature => {
        const zipCode = feature.properties[zipKey];
        if (!byZip[zipCode]) byZip[zipCode] = [];
        byZip[zipCode].push(feature.properties);
      });
      
      const rows = [];
      for (const [zip, propsArray] of Object.entries(byZip)) {
        const row = {[zipKey]: zip};
        numericFields.forEach(field => {
          if (/_pct$/i.test(field)) {
            // Average for percentage fields
            row[field] = propsArray.reduce((sum, props) => sum + props[field], 0) / propsArray.length;
          } else {
            // Sum for count fields
            row[field] = propsArray.reduce((sum, props) => sum + props[field], 0);
          }
        });
        rows.push(row);
      }
      return rows;
    }

    let dataTable, countChart, pctChart;

    function updateSummary() {
      const data = aggregate();
      
      // Update table
      const thead = document.querySelector('#summary thead');
      const tbody = document.querySelector('#summary tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';
      
      if (!data.length) {
        thead.innerHTML = '<tr><th style="text-align: center; padding: 20px;">No areas selected</th></tr>';
        if (countChart) countChart.destroy();
        if (pctChart) pctChart.destroy();
        return;
      }
      
      const columns = Object.keys(data[0]);
      const headerRow = document.createElement('tr');
      columns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      
      data.forEach(row => {
        const tr = document.createElement('tr');
        columns.forEach(col => {
          const td = document.createElement('td');
          if (/_pct$/i.test(col)) {
            td.textContent = row[col].toFixed(2) + '%';
          } else if (typeof row[col] === 'number') {
            td.textContent = Math.round(row[col]).toLocaleString();
          } else {
            td.textContent = row[col];
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      
      // Reinitialize DataTable
      if (dataTable) dataTable.destroy();
      dataTable = $('#summary').DataTable({
        pageLength: 10,
        order: [[0, 'asc']],
        scrollY: '200px',
        scrollCollapse: true
      });

      // Update charts
      updateCharts(data);
    }

    function updateCharts(data) {
      const countFields = numericFields.filter(f => !/_pct$/i.test(f));
      const pctFields = numericFields.filter(f => /_pct$/i.test(f));
      
      // Calculate totals and averages
      const totals = {};
      countFields.forEach(field => {
        totals[field] = data.reduce((sum, row) => sum + row[field], 0);
      });
      
      const averages = {};
      pctFields.forEach(field => {
        averages[field] = data.length ? 
          data.reduce((sum, row) => sum + row[field], 0) / data.length : 0;
      });

      // Chart colors
      const colors = [
        '#667eea', '#764ba2', '#f093fb', '#f5576c',
        '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
      ];

      // Count chart
      if (countChart) countChart.destroy();
      if (countFields.length > 0) {
        countChart = new Chart(document.getElementById('countChart'), {
          type: 'bar',
          data: {
            labels: countFields.map(f => f.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())),
            datasets: [{
              label: 'Total Count',
              data: countFields.map(f => totals[f]),
              backgroundColor: colors.slice(0, countFields.length),
              borderRadius: 8,
              borderSkipped: false,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.1)' }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });
      }

      // Percentage chart
      if (pctChart) pctChart.destroy();
      if (pctFields.length > 0) {
        pctChart = new Chart(document.getElementById('pctChart'), {
          type: 'bar',
          data: {
            labels: pctFields.map(f => f.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())),
            datasets: [{
              label: 'Average %',
              data: pctFields.map(f => averages[f]),
              backgroundColor: colors.slice(0, pctFields.length),
              borderRadius: 8,
              borderSkipped: false,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.1)' }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });
      }
    }

    // Initialize the dashboard
    refreshMap();
    updateQuickStats();
    updateSummary();

  } catch (error) {
    console.error('Error loading data:', error);
    document.getElementById('sidebar').innerHTML = `
      <div class="section">
        <div style="text-align: center; color: #ef4444; padding: 40px;">
          <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
          <h3>Error Loading Data</h3>
          <p>Could not load education-data.geojson</p>
          <p style="font-size: 14px; opacity: 0.7;">Please ensure the file exists in the same folder.</p>
        </div>
      </div>
    `;
  }
})();
</script>
</body>
</html>